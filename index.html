<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deutsch ‚Äî My Study Space</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Work+Sans:wght@300;400;500;600&family=Allura&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --ink: #0f0e0c; --paper: #f5f0e8; --gold: #b8913f; --gold-light: #d4a853;
  --muted: #7a7168; --border: rgba(184,145,63,0.25); --radius: 6px;
  --shadow: 0 2px 12px rgba(15,14,12,0.06); --shadow-deep: 0 8px 32px rgba(15,14,12,0.11);
  --shadow-card: 0 1px 3px rgba(15,14,12,0.08), 0 4px 12px rgba(15,14,12,0.05);
  --m: #4a6fa5; --f: #a54a6f; --n: #4a8f6f;
  --success: #4a8f6f; --error: #a54a6f;
}
html { scroll-behavior: smooth; }
body {
  background: var(--paper); color: var(--ink);
  font-family: 'Work Sans', sans-serif; font-weight: 300; min-height: 100vh;
  background-image: 
    radial-gradient(ellipse at 15% 0%, rgba(184,145,63,.1) 0%, transparent 55%),
    radial-gradient(ellipse at 85% 100%, rgba(184,145,63,.06) 0%, transparent 50%);
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header { 
  text-align: center; 
  padding: 3rem 2rem 2rem; 
  position: relative;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(to bottom, rgba(255,255,255,0.4), transparent);
}
header::after { 
  content: ''; 
  display: block; 
  width: 80px; 
  height: 2px; 
  background: linear-gradient(90deg, transparent, var(--gold), transparent); 
  margin: 1.5rem auto 0; 
}
.site-script { 
  font-family: 'Allura', cursive; 
  font-size: clamp(3rem, 8vw, 5.5rem); 
  color: var(--gold); 
  line-height: 1;
  text-shadow: 0 2px 8px rgba(184,145,63,0.15);
}
.site-sub { 
  font-family: 'Cormorant Garamond', serif; 
  font-size: 0.75rem; 
  letter-spacing: 0.45em; 
  text-transform: uppercase; 
  color: var(--muted); 
  margin-top: 0.5rem; 
}
.user-bar { 
  position: absolute; 
  right: 2rem; 
  top: 2rem; 
  display: flex; 
  align-items: center; 
  gap: 1rem;
  background: rgba(255,255,255,0.7);
  padding: 0.75rem 1.25rem;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  backdrop-filter: blur(8px);
}
.user-email { 
  font-size: 0.7rem; 
  letter-spacing: 0.12em; 
  color: var(--muted); 
}
.sync-status { 
  font-size: 0.65rem; 
  letter-spacing: 0.1em; 
  color: var(--success); 
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.sync-status::before {
  content: '‚óè';
  font-size: 0.5rem;
}
.sync-status.err { color: var(--error); }

/* ‚îÄ‚îÄ DRIVE LINK ‚îÄ‚îÄ */
.drive-link-bar {
  background: linear-gradient(135deg, rgba(74,111,165,0.08), rgba(184,145,63,0.08));
  border-bottom: 1px solid var(--border);
  padding: 1rem 2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
}
.drive-icon {
  width: 24px;
  height: 24px;
  background: linear-gradient(135deg, #4a6fa5, #b8913f);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.75rem;
  font-weight: 600;
}
.drive-link-text {
  font-size: 0.75rem;
  letter-spacing: 0.08em;
  color: var(--muted);
}
.drive-link {
  font-size: 0.75rem;
  letter-spacing: 0.05em;
  color: var(--gold);
  text-decoration: none;
  font-weight: 500;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s;
}
.drive-link:hover {
  border-bottom-color: var(--gold);
}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#auth-screen {
  display: flex; 
  align-items: center; 
  justify-content: center;
  min-height: calc(100vh - 180px); 
  padding: 2rem;
}
.auth-box {
  background: rgba(255,255,255,0.75); 
  border: 1px solid var(--border);
  border-radius: var(--radius); 
  box-shadow: var(--shadow-deep);
  padding: 3rem 3rem 2.5rem; 
  width: 100%; 
  max-width: 440px; 
  backdrop-filter: blur(12px);
}
.auth-tabs { 
  display: flex; 
  gap: 0; 
  margin-bottom: 2.5rem; 
  border-bottom: 1px solid var(--border); 
}
.auth-tab { 
  font-family: 'Work Sans', sans-serif; 
  font-size: 0.7rem; 
  font-weight: 500; 
  letter-spacing: 0.2em; 
  text-transform: uppercase; 
  color: var(--muted); 
  background: none; 
  border: none; 
  border-bottom: 2px solid transparent; 
  padding: 0.6rem 1.5rem 0.8rem; 
  cursor: pointer; 
  margin-bottom: -1px; 
  transition: all 0.2s; 
}
.auth-tab.active { 
  color: var(--gold); 
  border-bottom-color: var(--gold); 
}
.auth-form { display: none; }
.auth-form.active { display: block; }
.auth-form .fg { margin-bottom: 1rem; }
.auth-err { 
  font-size: 0.8rem; 
  color: var(--error); 
  margin-top: 1rem; 
  min-height: 1.2rem; 
  font-family: 'Cormorant Garamond', serif; 
  font-style: italic; 
}
.auth-note { 
  font-size: 0.75rem; 
  color: var(--muted); 
  margin-top: 1rem; 
  font-family: 'Cormorant Garamond', serif; 
  font-style: italic; 
  text-align: center; 
}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav { 
  display: flex; 
  justify-content: center; 
  padding: 1.5rem 2rem; 
  gap: 0.5rem;
  flex-wrap: wrap;
}
.tab-btn { 
  font-family: 'Work Sans', sans-serif; 
  font-size: 0.7rem; 
  font-weight: 500; 
  letter-spacing: 0.22em; 
  text-transform: uppercase; 
  color: var(--muted); 
  background: transparent;
  border: 1px solid transparent; 
  padding: 0.7rem 2rem; 
  cursor: pointer; 
  transition: all 0.25s;
  border-radius: var(--radius);
  position: relative;
}
.tab-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(184,145,63,0.05);
  opacity: 0;
  transition: opacity 0.25s;
  border-radius: var(--radius);
}
.tab-btn.active { 
  color: var(--gold); 
  border-color: var(--gold);
  background: rgba(184,145,63,0.08);
}
.tab-btn.active::before {
  opacity: 1;
}
.tab-btn:hover:not(.active) { 
  color: var(--ink);
  border-color: var(--border);
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
main { 
  max-width: 1200px; 
  margin: 0 auto; 
  padding: 3rem 2rem 6rem; 
}
.panel { display: none; }
.panel.active { 
  display: block; 
  animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes fadeUp { 
  from { opacity: 0; transform: translateY(12px); } 
  to { opacity: 1; transform: translateY(0); } 
}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-row { 
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 1rem;
  margin-bottom: 3rem;
}
.stat { 
  background: rgba(255,255,255,0.65);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-card);
  padding: 1.5rem 1.25rem;
  text-align: center;
  transition: transform 0.2s, box-shadow 0.2s;
}
.stat:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-deep);
}
.stat-num { 
  font-family: 'Cormorant Garamond', serif; 
  font-size: 2.2rem; 
  font-weight: 400; 
  color: var(--gold); 
  line-height: 1; 
}
.stat-num.m { color: var(--m); } 
.stat-num.f { color: var(--f); } 
.stat-num.n { color: var(--n); }
.stat-label { 
  font-size: 0.6rem; 
  letter-spacing: 0.2em; 
  text-transform: uppercase; 
  color: var(--muted); 
  margin-top: 0.5rem; 
}

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.section-header {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.section-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.8rem;
  font-weight: 500;
  color: var(--gold);
  font-style: italic;
}
.section-count {
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--muted);
}

/* ‚îÄ‚îÄ ADD CARD ‚îÄ‚îÄ */
.add-card { 
  background: rgba(255,255,255,0.7); 
  border: 1px solid var(--border); 
  border-radius: var(--radius); 
  box-shadow: var(--shadow-card); 
  margin-bottom: 3rem; 
  overflow: hidden;
  transition: box-shadow 0.3s;
}
.add-card:hover {
  box-shadow: var(--shadow-deep);
}
.add-card-header { 
  padding: 1.5rem 2rem; 
  border-bottom: 1px solid transparent; 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  cursor: pointer; 
  user-select: none; 
  transition: all 0.25s;
  background: linear-gradient(to right, transparent, rgba(184,145,63,0.03), transparent);
}
.add-card.open .add-card-header { 
  border-bottom-color: var(--border);
  background: rgba(184,145,63,0.05);
}
.add-card-title { 
  font-family: 'Cormorant Garamond', serif; 
  font-size: 1.15rem; 
  font-style: italic; 
  display: flex; 
  align-items: center; 
  gap: 0.75rem; 
}
.add-icon { 
  display: inline-flex; 
  width: 28px; 
  height: 28px; 
  background: var(--gold); 
  color: white; 
  border-radius: 50%; 
  align-items: center; 
  justify-content: center; 
  font-size: 1.1rem; 
  font-style: normal; 
  font-family: 'Work Sans', sans-serif; 
  flex-shrink: 0; 
  transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  box-shadow: 0 2px 8px rgba(184,145,63,0.3);
}
.add-card.open .add-icon { 
  transform: rotate(45deg); 
}
.add-card-hint { 
  font-size: 0.65rem; 
  letter-spacing: 0.15em; 
  text-transform: uppercase; 
  color: var(--muted); 
}
.add-card-body { 
  display: none; 
  padding: 2rem 2.5rem 2.5rem; 
}
.add-card.open .add-card-body { 
  display: block;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ‚îÄ‚îÄ WORD HERO INPUTS ‚îÄ‚îÄ */
.word-hero { 
  display: grid; 
  grid-template-columns: 130px 1fr 1fr; 
  border: 1px solid var(--border); 
  border-radius: var(--radius); 
  overflow: hidden; 
  margin-bottom: 1.75rem; 
  background: rgba(245,240,232,0.5);
  box-shadow: var(--shadow);
}
.wh-cell { 
  padding: 1.25rem 1.5rem; 
  display: flex; 
  flex-direction: column; 
  gap: 0.4rem; 
  border-right: 1px solid var(--border); 
}
.wh-cell:last-child { border-right: none; }
.wh-label { 
  font-size: 0.6rem; 
  letter-spacing: 0.2em; 
  text-transform: uppercase; 
  color: var(--muted); 
}
.wh-cell select, .wh-cell input { 
  font-family: 'Cormorant Garamond', serif; 
  font-size: 1.65rem; 
  font-weight: 400; 
  background: transparent; 
  border: none; 
  border-bottom: 2px solid rgba(184,145,63,0.2); 
  border-radius: 0; 
  padding: 0.2rem 0; 
  color: var(--ink); 
  width: 100%; 
  transition: border-color 0.2s; 
}
.wh-cell select { 
  font-size: 1.2rem; 
  cursor: pointer; 
}
.wh-cell select:focus, .wh-cell input:focus { 
  outline: none; 
  border-bottom-color: var(--gold); 
}
.wh-cell input::placeholder { 
  color: rgba(15,14,12,0.2); 
  font-style: italic; 
}
#v-translation, #edit-translation { 
  font-style: italic; 
  color: var(--muted); 
}

/* ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ */
.image-upload-section {
  margin-bottom: 1.75rem;
}
.image-preview-container {
  display: flex;
  gap: 1rem;
  align-items: flex-start;
  flex-wrap: wrap;
}
.image-preview {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 2px solid var(--border);
  box-shadow: var(--shadow);
}
.image-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.image-remove {
  position: absolute;
  top: 0.25rem;
  right: 0.25rem;
  width: 24px;
  height: 24px;
  background: rgba(165,74,111,0.95);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.image-remove:hover {
  background: #a54a6f;
  transform: scale(1.1);
}
.image-upload-btn {
  width: 120px;
  height: 120px;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  background: rgba(255,255,255,0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  gap: 0.5rem;
}
.image-upload-btn:hover {
  border-color: var(--gold);
  background: rgba(184,145,63,0.08);
}
.image-upload-btn span {
  font-size: 2rem;
  color: var(--gold);
}
.image-upload-btn div {
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
}

/* ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ */
.chips-label { 
  font-size: 0.65rem; 
  letter-spacing: 0.2em; 
  text-transform: uppercase; 
  color: var(--muted); 
  margin-bottom: 0.6rem; 
}
.chips { 
  display: flex; 
  flex-wrap: wrap; 
  gap: 0.5rem; 
  margin-bottom: 1.5rem; 
}
.chip { 
  font-size: 0.65rem; 
  letter-spacing: 0.12em; 
  text-transform: uppercase; 
  padding: 0.4rem 1rem; 
  border-radius: 20px; 
  border: 1px solid var(--border); 
  color: var(--muted); 
  background: rgba(255,255,255,0.5);
  cursor: pointer; 
  transition: all 0.2s; 
  font-family: 'Work Sans', sans-serif; 
  font-weight: 400; 
}
.chip.on { 
  background: var(--gold); 
  border-color: var(--gold); 
  color: white;
  box-shadow: 0 2px 8px rgba(184,145,63,0.3);
  transform: translateY(-1px);
}
.chip:hover:not(.on) { 
  border-color: var(--gold); 
  color: var(--gold); 
}

/* ‚îÄ‚îÄ FORM FIELDS ‚îÄ‚îÄ */
.dg { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
  gap: 1rem; 
  margin-bottom: 1rem; 
}
.fg { 
  display: flex; 
  flex-direction: column; 
  gap: 0.35rem; 
}
.fg.full { grid-column: 1/-1; }
.fg label { 
  font-size: 0.62rem; 
  letter-spacing: 0.18em; 
  text-transform: uppercase; 
  color: var(--muted); 
  font-weight: 500;
}
.fg input, .fg select, .fg textarea { 
  font-family: 'Work Sans', sans-serif; 
  font-weight: 300; 
  font-size: 0.9rem; 
  background: rgba(255,255,255,0.8); 
  border: 1px solid rgba(184,145,63,0.2); 
  border-radius: var(--radius); 
  padding: 0.6rem 0.9rem; 
  color: var(--ink); 
  transition: all 0.2s; 
  width: 100%; 
}
.fg input:focus, .fg select:focus, .fg textarea:focus { 
  outline: none; 
  border-color: var(--gold); 
  background: white;
  box-shadow: 0 0 0 3px rgba(184,145,63,0.1);
}
.fg textarea { 
  resize: vertical; 
  min-height: 70px; 
  font-family: 'Cormorant Garamond', serif;
}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn { 
  font-family: 'Work Sans', sans-serif; 
  font-size: 0.68rem; 
  font-weight: 600; 
  letter-spacing: 0.2em; 
  text-transform: uppercase; 
  padding: 0.7rem 1.8rem; 
  border: 1px solid var(--gold); 
  border-radius: var(--radius); 
  background: var(--gold); 
  color: white;
  cursor: pointer; 
  transition: all 0.2s; 
  box-shadow: 0 2px 8px rgba(184,145,63,0.2);
}
.btn:hover { 
  background: var(--gold-light); 
  border-color: var(--gold-light);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(184,145,63,0.3);
}
.btn:active {
  transform: translateY(0);
}
.btn:disabled { 
  opacity: 0.5; 
  cursor: not-allowed;
  transform: none;
}
.btn.sec { 
  background: transparent; 
  color: var(--gold);
  box-shadow: none;
}
.btn.sec:hover { 
  background: rgba(184,145,63,0.1);
  transform: translateY(-1px);
}
.btn.sm { 
  padding: 0.4rem 0.9rem; 
  font-size: 0.62rem; 
}
.btn.danger { 
  border-color: rgba(165,74,111,0.4); 
  color: #a54a6f; 
  background: transparent;
  box-shadow: none;
}
.btn.danger:hover { 
  background: rgba(165,74,111,0.08);
  border-color: #a54a6f;
}
.btn-row { 
  display: flex; 
  gap: 0.75rem; 
  align-items: center; 
  flex-wrap: wrap; 
  margin-top: 1.5rem; 
}

/* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
.filter-bar { 
  display: flex; 
  gap: 0.75rem; 
  margin-bottom: 2rem; 
  flex-wrap: wrap; 
  align-items: center;
  padding: 1.5rem;
  background: rgba(255,255,255,0.5);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.filter-bar input, .filter-bar select { 
  font-family: 'Work Sans', sans-serif; 
  font-weight: 300; 
  font-size: 0.85rem; 
  background: white;
  border: 1px solid var(--border); 
  border-radius: var(--radius); 
  padding: 0.6rem 0.9rem; 
  color: var(--ink); 
  transition: all 0.2s; 
  min-width: 120px; 
}
.filter-bar input:focus, .filter-bar select:focus { 
  outline: none; 
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(184,145,63,0.1);
}

/* ‚îÄ‚îÄ VOCAB CARDS ‚îÄ‚îÄ */
.vocab-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
  gap: 1.5rem; 
}
.vocab-card { 
  background: rgba(255,255,255,0.75); 
  border: 1px solid var(--border); 
  border-radius: var(--radius); 
  padding: 1.75rem; 
  box-shadow: var(--shadow-card);
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  position: relative;
  overflow: hidden;
}
.vocab-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gold);
  opacity: 0;
  transition: opacity 0.3s;
}
.vocab-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-deep);
}
.vocab-card:hover::before {
  opacity: 1;
}
.vocab-card[data-gender="der"]::before { background: var(--m); }
.vocab-card[data-gender="die"]::before { background: var(--f); }
.vocab-card[data-gender="das"]::before { background: var(--n); }

.vocab-image {
  width: 100%;
  height: 160px;
  object-fit: cover;
  border-radius: var(--radius);
  margin-bottom: 1rem;
  border: 1px solid var(--border);
}

.vc-word { 
  font-family: 'Cormorant Garamond', serif; 
  font-size: 1.75rem; 
  font-weight: 500; 
  margin-bottom: 0.5rem; 
  display: flex; 
  align-items: baseline; 
  gap: 0.6rem;
  line-height: 1.3;
}
.vc-art { 
  font-size: 1.1rem; 
  font-weight: 400; 
  font-style: italic;
  opacity: 0.8;
}
.vc-art.der { color: var(--m); }
.vc-art.die { color: var(--f); }
.vc-art.das { color: var(--n); }

.vc-trans { 
  font-size: 0.95rem; 
  color: var(--muted); 
  margin-bottom: 1rem; 
  font-style: italic;
  font-family: 'Cormorant Garamond', serif;
}

.vc-tags { 
  display: flex; 
  flex-wrap: wrap; 
  gap: 0.4rem; 
  margin-bottom: 1rem; 
}
.tag { 
  font-size: 0.6rem; 
  letter-spacing: 0.12em; 
  text-transform: uppercase; 
  padding: 0.3rem 0.7rem; 
  border-radius: 12px; 
  background: rgba(184,145,63,0.1); 
  color: var(--gold);
  border: 1px solid rgba(184,145,63,0.2);
}
.tag.topic { 
  background: rgba(74,111,165,0.12); 
  color: var(--m);
  border-color: rgba(74,111,165,0.25);
}

.vc-extra { 
  font-size: 0.85rem; 
  color: var(--muted); 
  margin-top: 1rem; 
  padding-top: 1rem; 
  border-top: 1px solid var(--border);
  line-height: 1.6;
}
.vc-el { 
  font-size: 0.6rem; 
  letter-spacing: 0.15em; 
  text-transform: uppercase; 
  color: var(--gold); 
  display: block; 
  margin-bottom: 0.3rem;
  font-weight: 500;
}
.vc-ctx { 
  margin-top: 0.5rem; 
  padding-left: 1rem; 
  border-left: 2px solid var(--gold);
  font-family: 'Cormorant Garamond', serif;
  font-style: italic;
}

/* ‚îÄ‚îÄ DICTIONARY LINKS ‚îÄ‚îÄ */
.dict-links {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(184,145,63,0.12);
  flex-wrap: wrap;
}

.dict-link {
  font-size: 0.62rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--gold);
  text-decoration: none;
  padding: 0.35rem 0.7rem;
  border: 1px solid var(--border);
  border-radius: 3px;
  background: rgba(184,145,63,0.04);
  transition: all 0.2s;
  font-family: 'Work Sans', sans-serif;
  font-weight: 500;
}

.dict-link:hover {
  background: var(--gold);
  color: white;
  border-color: var(--gold);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(184,145,63,0.2);
}

/* Form dictionary links (in add/edit) */
.form-dict-links {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.9rem 1.2rem;
  background: linear-gradient(135deg, rgba(184,145,63,0.08), rgba(74,111,165,0.08));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin: 1.2rem 0;
  flex-wrap: wrap;
}

.form-dict-label {
  font-size: 0.65rem;
  letter-spacing: 0.08em;
  color: var(--muted);
  font-weight: 500;
  font-family: 'Work Sans', sans-serif;
}

.form-dict-link {
  font-size: 0.68rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--gold);
  text-decoration: none;
  padding: 0.4rem 0.9rem;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: white;
  transition: all 0.2s;
  font-family: 'Work Sans', sans-serif;
  font-weight: 600;
}

.form-dict-link:hover {
  background: var(--gold);
  color: white;
  border-color: var(--gold);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(184,145,63,0.25);
}


.card-actions { 
  margin-top: 1rem; 
  display: flex; 
  gap: 0.5rem; 
  padding-top: 1rem;
  border-top: 1px solid rgba(184,145,63,0.15);
}

/* ‚îÄ‚îÄ NOTES & RESOURCES ‚îÄ‚îÄ */
.notes-resources-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-bottom: 3rem;
}
@media (max-width: 900px) {
  .notes-resources-container {
    grid-template-columns: 1fr;
  }
}

.notes-section, .resources-section {
  background: rgba(255,255,255,0.5);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 2rem;
  box-shadow: var(--shadow-card);
}

.subsection-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  font-weight: 500;
  color: var(--gold);
  margin-bottom: 1.5rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
  font-style: italic;
}

.notes-grid, .resources-grid { 
  display: grid;
  gap: 1.25rem;
}

.note-card, .resource-card { 
  background: white;
  border: 1px solid var(--border); 
  border-radius: var(--radius); 
  padding: 1.5rem; 
  box-shadow: var(--shadow);
  transition: all 0.25s;
  position: relative;
}
.note-card:hover, .resource-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-deep);
}

.note-type, .resource-type { 
  font-size: 0.6rem; 
  letter-spacing: 0.15em; 
  text-transform: uppercase; 
  color: var(--gold);
  margin-bottom: 0.6rem;
  font-weight: 600;
}

.note-title, .resource-title { 
  font-family: 'Cormorant Garamond', serif; 
  font-size: 1.2rem; 
  font-weight: 500; 
  margin-bottom: 0.75rem;
  line-height: 1.4;
}

.note-body, .resource-body { 
  font-size: 0.85rem; 
  line-height: 1.7; 
  color: var(--muted); 
  margin-bottom: 1rem;
  font-family: 'Cormorant Garamond', serif;
}

.note-link, .resource-link { 
  display: inline-block;
  font-size: 0.75rem; 
  color: var(--gold); 
  text-decoration: none; 
  margin-top: 0.75rem;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s;
  word-break: break-all;
}
.note-link:hover, .resource-link:hover { 
  border-bottom-color: var(--gold); 
}

/* ‚îÄ‚îÄ QUIZ MODE ‚îÄ‚îÄ */
.quiz-controls {
  background: rgba(255,255,255,0.6);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 2rem;
  margin-bottom: 2.5rem;
  box-shadow: var(--shadow-card);
}

.quiz-mode-selector {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.quiz-mode-btn {
  background: white;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 1.5rem;
  cursor: pointer;
  transition: all 0.25s;
  text-align: center;
}
.quiz-mode-btn:hover {
  border-color: var(--gold);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}
.quiz-mode-btn.active {
  background: linear-gradient(135deg, rgba(184,145,63,0.1), rgba(184,145,63,0.05));
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(184,145,63,0.1);
}
.quiz-mode-btn .mode-icon {
  font-size: 2rem;
  margin-bottom: 0.75rem;
}
.quiz-mode-btn .mode-name {
  font-size: 0.75rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--ink);
  font-weight: 600;
}
.quiz-mode-btn .mode-desc {
  font-size: 0.7rem;
  color: var(--muted);
  margin-top: 0.5rem;
  font-family: 'Cormorant Garamond', serif;
  font-style: italic;
}

.quiz-settings {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.quiz-card {
  background: white;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 3rem 2rem;
  min-height: 350px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-deep);
  transition: transform 0.6s;
  transform-style: preserve-3d;
  position: relative;
}

.quiz-card.flipped {
  transform: rotateY(180deg);
}

.quiz-card-front, .quiz-card-back {
  backface-visibility: hidden;
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 2rem;
}

.quiz-card-back {
  transform: rotateY(180deg);
}

.quiz-word {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2.5rem;
  font-weight: 500;
  text-align: center;
  margin-bottom: 1rem;
  color: var(--ink);
}

.quiz-article {
  font-size: 1.5rem;
  color: var(--gold);
  margin-bottom: 0.5rem;
  font-style: italic;
}

.quiz-translation {
  font-size: 1.5rem;
  color: var(--muted);
  text-align: center;
  font-style: italic;
  font-family: 'Cormorant Garamond', serif;
}

.quiz-image {
  max-width: 200px;
  max-height: 200px;
  border-radius: var(--radius);
  margin-bottom: 1.5rem;
  border: 2px solid var(--border);
}

.quiz-options {
  display: grid;
  gap: 1rem;
  width: 100%;
  max-width: 600px;
  margin: 2rem auto;
}

.quiz-option {
  background: white;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 1.25rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.2rem;
}
.quiz-option:hover {
  border-color: var(--gold);
  background: rgba(184,145,63,0.05);
  transform: translateX(4px);
}
.quiz-option.correct {
  background: rgba(74,143,111,0.15);
  border-color: var(--success);
}
.quiz-option.incorrect {
  background: rgba(165,74,111,0.15);
  border-color: var(--error);
}

.quiz-input-container {
  width: 100%;
  max-width: 500px;
  margin: 2rem auto;
}
.quiz-input {
  width: 100%;
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.5rem;
  text-align: center;
  padding: 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  background: white;
  transition: all 0.2s;
}
.quiz-input:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 4px rgba(184,145,63,0.1);
}

.quiz-feedback {
  text-align: center;
  font-size: 1.1rem;
  margin-top: 1.5rem;
  font-family: 'Cormorant Garamond', serif;
  font-weight: 500;
}
.quiz-feedback.correct {
  color: var(--success);
}
.quiz-feedback.incorrect {
  color: var(--error);
}

.quiz-progress {
  text-align: center;
  font-size: 0.75rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 2rem;
}

.quiz-score {
  background: linear-gradient(135deg, rgba(184,145,63,0.1), rgba(74,111,165,0.1));
  border: 2px solid var(--gold);
  border-radius: var(--radius);
  padding: 3rem 2rem;
  text-align: center;
  max-width: 500px;
  margin: 0 auto;
}
.quiz-score-number {
  font-family: 'Cormorant Garamond', serif;
  font-size: 4rem;
  color: var(--gold);
  margin-bottom: 1rem;
}
.quiz-score-text {
  font-size: 1.1rem;
  color: var(--muted);
  margin-bottom: 2rem;
}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state { 
  text-align: center; 
  padding: 4rem 2rem;
  grid-column: 1/-1;
}
.empty-script { 
  font-family: 'Allura', cursive; 
  font-size: 3rem; 
  color: var(--gold); 
  opacity: 0.4;
  margin-bottom: 1rem;
}
.empty-state p { 
  color: var(--muted); 
  font-family: 'Cormorant Garamond', serif;
  font-style: italic;
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast-container { 
  position: fixed; 
  top: 2rem; 
  right: 2rem; 
  z-index: 9999; 
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.toast { 
  background: white;
  border: 1px solid var(--border); 
  border-left: 4px solid var(--gold);
  border-radius: var(--radius); 
  padding: 1rem 1.5rem; 
  box-shadow: var(--shadow-deep);
  animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  min-width: 280px;
  backdrop-filter: blur(12px);
}
.toast.err { 
  border-left-color: var(--error); 
}
@keyframes slideIn { 
  from { 
    opacity: 0; 
    transform: translateX(100px); 
  } 
  to { 
    opacity: 1; 
    transform: translateX(0); 
  } 
}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .word-hero { grid-template-columns: 1fr; }
  .wh-cell { border-right: none; border-bottom: 1px solid var(--border); }
  .wh-cell:last-child { border-bottom: none; }
  .vocab-grid { grid-template-columns: 1fr; }
  .user-bar { position: static; margin-bottom: 1rem; }
  header { padding-top: 2rem; }
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .quiz-mode-selector { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- AUTH SCREEN -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>

    <form id="signin-form" class="auth-form active" onsubmit="signIn(event)">
      <div class="fg">
        <label>Email</label>
        <input type="email" id="si-email" required autocomplete="email">
      </div>
      <div class="fg">
        <label>Password</label>
        <input type="password" id="si-pass" required autocomplete="current-password">
      </div>
      <div class="auth-err" id="si-err"></div>
      <button type="submit" class="btn" style="width:100%;margin-top:1rem">Sign In</button>
      <div class="auth-note">Start your German study journey</div>
    </form>

    <form id="signup-form" class="auth-form" onsubmit="signUp(event)">
      <div class="fg">
        <label>Email</label>
        <input type="email" id="su-email" required autocomplete="email">
      </div>
      <div class="fg">
        <label>Password</label>
        <input type="password" id="su-pass" required autocomplete="new-password">
      </div>
      <div class="auth-err" id="su-err"></div>
      <button type="submit" class="btn" style="width:100%;margin-top:1rem">Create Account</button>
      <div class="auth-note">Join to save your progress</div>
    </form>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MAIN APP -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app" style="display:none">
  <header>
    <div class="user-bar">
      <span class="user-email" id="user-email"></span>
      <span class="sync-status" id="sync-status">synced</span>
      <button class="btn sm sec" onclick="signOut()">Sign Out</button>
    </div>
    <div class="site-script">Deutsch</div>
    <div class="site-sub">My Study Space</div>
  </header>

  <div class="drive-link-bar">
    <div class="drive-icon">üìÅ</div>
    <span class="drive-link-text">Study Materials:</span>
    <a href="https://drive.google.com/drive/folders/1xn9RQSOTxy7acph7xI0lGTlSSGLJqf83" target="_blank" rel="noopener" class="drive-link">Open Google Drive Folder ‚Üí</a>
  </div>

  <nav>
    <button class="tab-btn active" onclick="switchTab('vocab')">Vocabulary</button>
    <button class="tab-btn" onclick="switchTab('quiz')">Quiz</button>
    <button class="tab-btn" onclick="switchTab('notes')">Notes</button>
    <button class="tab-btn" onclick="switchTab('resources')">Resources</button>
  </nav>

  <main>
    <!-- ‚îÄ‚îÄ VOCABULARY PANEL ‚îÄ‚îÄ -->
    <div id="panel-vocab" class="panel active">
      <div id="stats-row" class="stats-row"></div>

      <div class="add-card" id="add-vocab-card">
        <div class="add-card-header" onclick="g('add-vocab-card').classList.toggle('open')">
          <div class="add-card-title">
            <span class="add-icon">+</span>
            Add New Word
          </div>
          <div class="add-card-hint">Click to expand</div>
        </div>
        <div class="add-card-body">
          <div class="word-hero">
            <div class="wh-cell">
              <div class="wh-label">Article</div>
              <select id="v-gender">
                <option value="">‚Äî</option>
                <option value="der">der</option>
                <option value="die">die</option>
                <option value="das">das</option>
              </select>
            </div>
            <div class="wh-cell">
              <div class="wh-label">German Word</div>
              <input type="text" id="v-word" placeholder="Wort" oninput="updateDictLinks('v')">
            </div>
            <div class="wh-cell">
              <div class="wh-label">Translation</div>
              <input type="text" id="v-translation" placeholder="meaning">
            </div>
          </div>

          <div class="form-dict-links" id="v-dict-links" style="display:none">
            <div class="form-dict-label">üîç Quick Lookup:</div>
            <a href="#" target="_blank" rel="noopener" class="form-dict-link" id="v-link-leo">LEO</a>
            <a href="#" target="_blank" rel="noopener" class="form-dict-link" id="v-link-wikt">Wiktionary</a>
            <a href="#" target="_blank" rel="noopener" class="form-dict-link" id="v-link-deepl">DeepL</a>
            <a href="#" target="_blank" rel="noopener" class="form-dict-link" id="v-link-reverso">Reverso</a>
          </div>

          <div class="image-upload-section">
            <div class="chips-label">Add Image (optional)</div>
            <div class="image-preview-container">
              <div id="v-image-preview"></div>
              <label class="image-upload-btn" for="v-image-input">
                <span>üì∑</span>
                <div>Add Photo</div>
              </label>
              <input type="file" id="v-image-input" accept="image/*" style="display:none" onchange="handleImageUpload(event, 'v-image-preview', 'vocab')">
            </div>
          </div>

          <div class="chips-label">Quick Tags</div>
          <div class="chips" id="v-tags-chips">
            <span class="chip" onclick="this.classList.toggle('on')">High Frequency</span>
            <span class="chip" onclick="this.classList.toggle('on')">Collocation</span>
            <span class="chip" onclick="this.classList.toggle('on')">Idiom</span>
            <span class="chip" onclick="this.classList.toggle('on')">Must Know</span>
          </div>

          <div class="dg">
            <div class="fg"><label>Topic</label><input type="text" id="v-topic"></div>
            <div class="fg"><label>Week</label><input type="number" id="v-week"></div>
            <div class="fg"><label>Quarter</label><select id="v-quarter"><option value="">‚Äî</option><option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option></select></div>
            <div class="fg"><label>Year</label><input type="number" id="v-year" placeholder="2025"></div>
            <div class="fg full"><label>Cases / Conjugation</label><input type="text" id="v-cases" placeholder="Nominative, Akkusativ, etc."></div>
            <div class="fg full"><label>Context / Example Sentence</label><textarea id="v-context" placeholder="Use in a sentence..."></textarea></div>
          </div>

          <div class="btn-row">
            <button class="btn" onclick="addVocab()">Add Word</button>
            <button class="btn sec" onclick="clearVocabForm()">Clear</button>
          </div>
        </div>
      </div>

      <div class="filter-bar">
        <input type="text" id="vocab-search" placeholder="Search words..." oninput="renderVocab()">
        <select id="filter-gender" onchange="renderVocab()"><option value="">All Genders</option><option value="der">der</option><option value="die">die</option><option value="das">das</option></select>
        <select id="filter-quarter" onchange="renderVocab()"><option value="">All Quarters</option><option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option></select>
        <select id="filter-topic" onchange="renderVocab()"><option value="">All Topics</option></select>
        <select id="sort-order" onchange="renderVocab()"><option value="recent">Recent</option><option value="alpha">A-Z</option><option value="week">By Week</option></select>
        <span class="section-count" id="vocab-count"></span>
        <button class="btn sm" onclick="exportCSV()" style="margin-left:auto">Export CSV</button>
        <label class="btn sm sec" for="import-csv">Import CSV</label>
        <input type="file" id="import-csv" accept=".csv" style="display:none" onchange="importCSV(event)">
      </div>

      <div class="vocab-grid" id="vocab-grid"></div>
    </div>

    <!-- ‚îÄ‚îÄ QUIZ PANEL ‚îÄ‚îÄ -->
    <div id="panel-quiz" class="panel">
      <div class="section-header">
        <div class="section-title">Quiz Time</div>
      </div>

      <div class="quiz-controls">
        <div class="chips-label">Select Quiz Mode</div>
        <div class="quiz-mode-selector">
          <div class="quiz-mode-btn active" onclick="selectQuizMode('flashcard')">
            <div class="mode-icon">üé¥</div>
            <div class="mode-name">Flashcards</div>
            <div class="mode-desc">Flip to reveal translation</div>
          </div>
          <div class="quiz-mode-btn" onclick="selectQuizMode('multiple')">
            <div class="mode-icon">‚úì</div>
            <div class="mode-name">Multiple Choice</div>
            <div class="mode-desc">Choose the correct answer</div>
          </div>
          <div class="quiz-mode-btn" onclick="selectQuizMode('typing')">
            <div class="mode-icon">‚å®Ô∏è</div>
            <div class="mode-name">Type Answer</div>
            <div class="mode-desc">Test your spelling</div>
          </div>
          <div class="quiz-mode-btn" onclick="selectQuizMode('gender')">
            <div class="mode-icon">üéØ</div>
            <div class="mode-name">Gender Quiz</div>
            <div class="mode-desc">der, die, or das?</div>
          </div>
        </div>

        <div class="quiz-settings">
          <div class="fg">
            <label>Number of Questions</label>
            <select id="quiz-count">
              <option value="5">5 questions</option>
              <option value="10" selected>10 questions</option>
              <option value="20">20 questions</option>
              <option value="all">All words</option>
            </select>
          </div>
          <div class="fg">
            <label>Filter by Topic</label>
            <select id="quiz-topic-filter">
              <option value="">All Topics</option>
            </select>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn" onclick="startQuiz()">Start Quiz</button>
          <button class="btn sec" onclick="resetQuiz()">Reset</button>
        </div>
      </div>

      <div id="quiz-area"></div>
    </div>

    <!-- ‚îÄ‚îÄ NOTES PANEL ‚îÄ‚îÄ -->
    <div id="panel-notes" class="panel">
      <div class="section-header">
        <div class="section-title">Study Notes</div>
        <div class="section-count" id="notes-count"></div>
      </div>

      <div class="add-card" id="add-note-card">
        <div class="add-card-header" onclick="g('add-note-card').classList.toggle('open')">
          <div class="add-card-title">
            <span class="add-icon">+</span>
            Add New Note
          </div>
          <div class="add-card-hint">Click to expand</div>
        </div>
        <div class="add-card-body">
          <div class="dg">
            <div class="fg">
              <label>Type</label>
              <select id="n-type" onchange="toggleLink()">
                <option value="note">General Note</option>
                <option value="grammar">Grammar</option>
                <option value="pronunciation">Pronunciation</option>
                <option value="culture">Culture</option>
                <option value="tip">Study Tip</option>
                <option value="phrase">Useful Phrase</option>
              </select>
            </div>
            <div class="fg">
              <label>Title</label>
              <input type="text" id="n-title" placeholder="Note title">
            </div>
            <div class="fg full">
              <label>Content</label>
              <textarea id="n-body" placeholder="Write your note here..."></textarea>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn" onclick="addNote()">Add Note</button>
            <button class="btn sec" onclick="clearNoteForm()">Clear</button>
          </div>
        </div>
      </div>

      <div class="filter-bar">
        <input type="text" id="note-search" placeholder="Search notes..." oninput="renderNotes()">
        <select id="note-type-filter" onchange="renderNotes()">
          <option value="">All Types</option>
          <option value="note">General Note</option>
          <option value="grammar">Grammar</option>
          <option value="pronunciation">Pronunciation</option>
          <option value="culture">Culture</option>
          <option value="tip">Study Tip</option>
          <option value="phrase">Useful Phrase</option>
        </select>
      </div>

      <div class="notes-grid" id="notes-grid"></div>
    </div>

    <!-- ‚îÄ‚îÄ RESOURCES PANEL ‚îÄ‚îÄ -->
    <div id="panel-resources" class="panel">
      <div class="section-header">
        <div class="section-title">Learning Resources</div>
        <div class="section-count" id="resources-count"></div>
      </div>

      <div class="add-card" id="add-resource-card">
        <div class="add-card-header" onclick="g('add-resource-card').classList.toggle('open')">
          <div class="add-card-title">
            <span class="add-icon">+</span>
            Add New Resource
          </div>
          <div class="add-card-hint">Click to expand</div>
        </div>
        <div class="add-card-body">
          <div class="dg">
            <div class="fg">
              <label>Type</label>
              <select id="r-type">
                <option value="youtube">YouTube Video</option>
                <option value="website">Website</option>
                <option value="book">Book</option>
                <option value="podcast">Podcast</option>
                <option value="film">Film/Series</option>
                <option value="app">App</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="fg">
              <label>Title</label>
              <input type="text" id="r-title" placeholder="Resource title">
            </div>
            <div class="fg full">
              <label>Description (optional)</label>
              <textarea id="r-body" placeholder="Why is this resource helpful?"></textarea>
            </div>
            <div class="fg full">
              <label>Link</label>
              <input type="url" id="r-link" placeholder="https://...">
            </div>
          </div>
          <div class="btn-row">
            <button class="btn" onclick="addResource()">Add Resource</button>
            <button class="btn sec" onclick="clearResourceForm()">Clear</button>
          </div>
        </div>
      </div>

      <div class="filter-bar">
        <input type="text" id="resource-search" placeholder="Search resources..." oninput="renderResources()">
        <select id="resource-type-filter" onchange="renderResources()">
          <option value="">All Types</option>
          <option value="youtube">YouTube</option>
          <option value="website">Website</option>
          <option value="book">Book</option>
          <option value="podcast">Podcast</option>
          <option value="film">Film/Series</option>
          <option value="app">App</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="resources-grid" id="resources-grid"></div>
    </div>
  </main>
</div>

<div class="toast-container" id="toast-container"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- EDIT MODAL -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="edit-modal" style="display:none;position:fixed;inset:0;background:rgba(15,14,12,.4);z-index:9000;backdrop-filter:blur(4px);overflow:auto;padding:2rem">
  <div style="max-width:800px;margin:0 auto;background:var(--paper);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow-deep);padding:2.5rem">
    <h2 style="font-family:'Cormorant Garamond',serif;font-size:1.8rem;margin-bottom:2rem;color:var(--gold)">Edit Word</h2>
    <div class="word-hero">
      <div class="wh-cell">
        <div class="wh-label">Article</div>
        <select id="edit-gender">
          <option value="">‚Äî</option>
          <option value="der">der</option>
          <option value="die">die</option>
          <option value="das">das</option>
        </select>
      </div>
      <div class="wh-cell">
        <div class="wh-label">German Word</div>
        <input type="text" id="edit-word" oninput="updateDictLinks('edit')">
      </div>
      <div class="wh-cell">
        <div class="wh-label">Translation</div>
        <input type="text" id="edit-translation">
      </div>
    </div>

    <div class="form-dict-links" id="edit-dict-links" style="display:none">
      <div class="form-dict-label">üîç Quick Lookup:</div>
      <a href="#" target="_blank" rel="noopener" class="form-dict-link" id="edit-link-leo">LEO</a>
      <a href="#" target="_blank" rel="noopener" class="form-dict-link" id="edit-link-wikt">Wiktionary</a>
      <a href="#" target="_blank" rel="noopener" class="form-dict-link" id="edit-link-deepl">DeepL</a>
      <a href="#" target="_blank" rel="noopener" class="form-dict-link" id="edit-link-reverso">Reverso</a>
    </div>

    <div class="image-upload-section">
      <div class="chips-label">Edit Image (optional)</div>
      <div class="image-preview-container">
        <div id="edit-image-preview"></div>
        <label class="image-upload-btn" for="edit-image-input">
          <span>üì∑</span>
          <div>Add Photo</div>
        </label>
        <input type="file" id="edit-image-input" accept="image/*" style="display:none" onchange="handleImageUpload(event, 'edit-image-preview', 'edit')">
      </div>
    </div>

    <div class="dg" style="margin-top:1.5rem">
      <div class="fg"><label>Topic</label><input type="text" id="edit-topic"></div>
      <div class="fg"><label>Week</label><input type="number" id="edit-week"></div>
      <div class="fg"><label>Quarter</label><select id="edit-quarter"><option value="">‚Äî</option><option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option></select></div>
      <div class="fg"><label>Year</label><input type="number" id="edit-year"></div>
      <div class="fg full"><label>Cases / Conjugation</label><input type="text" id="edit-cases"></div>
      <div class="fg full"><label>Context / Example</label><textarea id="edit-context"></textarea></div>
    </div>
    <div class="btn-row">
      <button class="btn" onclick="saveEdit()">Save Changes</button>
      <button class="btn sec" onclick="closeEdit()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE - USING WORKING CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB = {
  url: 'https://cjjutbqvkcqqzxduqipe.supabase.co',
  key: 'sb_publishable_jgqgGhV9DyWJ3sTJVUISwg_8yUR1Lt6',
  user: null,

  headers(extra={}) {
    const h = { 'Content-Type':'application/json', 'apikey': this.key, ...extra };
    if (this.user?.token) h['Authorization'] = `Bearer ${this.user.token}`;
    return h;
  },

  async signUp(email, password) {
    const r = await fetch(`${this.url}/auth/v1/signup`, {
      method:'POST', headers: this.headers(),
      body: JSON.stringify({ email, password })
    });
    const d = await r.json();
    if (d.error || d.msg) throw new Error(d.error_description || d.msg || d.error);
    if (!d.access_token) throw new Error('Check your email to confirm your account, then sign in.');
    this.user = { uid:d.user.id, email:d.user.email, token:d.access_token, refresh:d.refresh_token };
    await this._persist();
    return this.user;
  },

  async signIn(email, password) {
    const r = await fetch(`${this.url}/auth/v1/token?grant_type=password`, {
      method:'POST', headers: this.headers(),
      body: JSON.stringify({ email, password })
    });
    const d = await r.json();
    if (d.error || d.error_description) throw new Error(d.error_description || d.error);
    this.user = { uid:d.user.id, email:d.user.email, token:d.access_token, refresh:d.refresh_token };
    await this._persist();
    return this.user;
  },

  async signOut() {
    try {
      await fetch(`${this.url}/auth/v1/logout`, { method:'POST', headers: this.headers() });
    } catch(e){}
    this.user = null;
    try { localStorage.removeItem('sb_user'); } catch(e){}
  },

  async refreshToken() {
    if (!this.user?.refresh) return;
    try {
      const r = await fetch(`${this.url}/auth/v1/token?grant_type=refresh_token`, {
        method:'POST', headers: this.headers(),
        body: JSON.stringify({ refresh_token: this.user.refresh })
      });
      const d = await r.json();
      if (d.access_token) {
        this.user.token = d.access_token;
        this.user.refresh = d.refresh_token;
        await this._persist();
      }
    } catch(e){}
  },

  async saveData(vocab, notes, resources) {
    const body = { 
      user_id: this.user.uid, 
      vocab: JSON.stringify(vocab), 
      notes: JSON.stringify(notes),
      resources: JSON.stringify(resources)
    };
    const r = await fetch(`${this.url}/rest/v1/deutsch_data?on_conflict=user_id`, {
      method:'POST',
      headers: this.headers({ 'Prefer':'return=minimal,resolution=merge-duplicates' }),
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      let msg = r.statusText;
      try { const e=await r.json(); msg=e.message||e.hint||JSON.stringify(e); } catch(ex){}
      throw new Error(msg);
    }
    return true;
  },

  async loadData() {
    const r = await fetch(`${this.url}/rest/v1/deutsch_data?user_id=eq.${this.user.uid}&select=*`, {
      headers: this.headers()
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.message||JSON.stringify(d));
    if (!d || !d.length) return { vocab:[], notes:[], resources:[] };
    return {
      vocab: JSON.parse(d[0].vocab || '[]'),
      notes: JSON.parse(d[0].notes || '[]'),
      resources: JSON.parse(d[0].resources || '[]')
    };
  },

  _dbName:'DeutschDB', _store:'auth',
  async _getDB() {
    return new Promise((res,rej)=>{
      const req = indexedDB.open(this._dbName,1);
      req.onerror = ()=>rej(req.error);
      req.onsuccess = ()=>res(req.result);
      req.onupgradeneeded = e=>{ const db=e.target.result; if(!db.objectStoreNames.contains(this._store)) db.createObjectStore(this._store); };
    });
  },

  async _persist() {
    try {
      const db = await this._getDB();
      const tx = db.transaction(this._store,'readwrite');
      tx.objectStore(this._store).put(this.user,'user');
      await new Promise((res,rej)=>{ tx.oncomplete=res; tx.onerror=()=>rej(tx.error); });
    } catch(e){ console.warn('Could not persist session',e); }
  },

  async restoreSession() {
    try {
      const db = await this._getDB();
      const tx = db.transaction(this._store);
      const u = await new Promise((res,rej)=>{
        const req = tx.objectStore(this._store).get('user');
        req.onsuccess = ()=>res(req.result);
        req.onerror = ()=>rej(req.error);
      });
      if (u && u.token) {
        this.user = u;
        await this.refreshToken();
        return this.user;
      }
    } catch(e){ console.warn('Could not restore session',e); }
    return null;
  }
};


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let vocab = [], notes = [], resources = [], currentUser = null, saveTimer = null;
let currentEditId = null;
let quizMode = 'flashcard', quizData = [], quizIndex = 0, quizScore = 0, quizAnswered = false;
let currentImage = { vocab: null, edit: null };

function g(id) { return document.getElementById(id); }
function esc(str) { 
  const div = document.createElement('div'); 
  div.textContent = str; 
  return div.innerHTML; 
}

function updateSyncStatus(status) {
  const el = g('sync-status');
  if (!el) return;
  el.classList.remove('err');
  if (status === 'synced') el.textContent = 'synced';
  else if (status === 'saving') el.textContent = 'saving...';
  else if (status === 'syncing') el.textContent = 'loading...';
  else if (status === 'err') {
    el.textContent = 'error';
    el.classList.add('err');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
  event.target.classList.add('active');
  g(tab + '-form').classList.add('active');
}

async function signUp(e) {
  e.preventDefault();
  const email = g('su-email').value.trim(), pass = g('su-pass').value;
  try {
    await SB.signUp(email, pass);
    g('su-err').textContent = 'Check your email to confirm!';
    setTimeout(() => switchAuthTab('signin'), 2000);
  } catch (err) {
    g('su-err').textContent = err.message;
  }
}

async function signIn(e) {
  e.preventDefault();
  const email = g('si-email').value.trim(), pass = g('si-pass').value;
  try {
    const user = await SB.signIn(email, pass);
    await bootApp();
  } catch (err) {
    g('si-err').textContent = err.message;
  }
}

async function signOut() {
  await SB.signOut();
  location.reload();
}

async function bootApp() {
  const user = await SB.restoreSession();
  if (!user) return;
  currentUser = user;
  g('user-email').textContent = user.email;
  g('auth-screen').style.display = 'none';
  g('app').style.display = 'block';
  updateSyncStatus('syncing');
  
  try {
    const data = await SB.loadData();
    vocab = data.vocab || [];
    notes = data.notes || [];
    resources = data.resources || [];
    
    updateTopicDrop();
    updateQuizTopicDrop();
    renderVocab();
    renderNotes();
    renderResources();
    updateSyncStatus('synced');
  } catch (err) {
    console.error('Load error:', err);
    updateSyncStatus('err');
    toast('Could not load data: ' + err.message, 'err');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scheduleSave() {
  clearTimeout(saveTimer);
  updateSyncStatus('saving');
  saveTimer = setTimeout(async () => {
    try {
      await SB.saveData(vocab, notes, resources);
      updateSyncStatus('synced');
    } catch (err) {
      console.error('Save error:', err);
      updateSyncStatus('err');
      toast('Could not save: ' + err.message, 'err');
    }
  }, 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = '') {
  const t = document.createElement('div');
  t.className = 'toast' + (type ? ' ' + type : '');
  t.textContent = msg;
  g('toast-container').appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  g('panel-' + name).classList.add('active');
  
  if (name === 'quiz') {
    updateQuizTopicDrop();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleImageUpload(event, previewId, type) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    currentImage[type] = e.target.result;
    const preview = g(previewId);
    preview.innerHTML = `
      <div class="image-preview">
        <img src="${e.target.result}" alt="Preview">
        <button class="image-remove" onclick="removeImage('${previewId}', '${type}')">√ó</button>
      </div>
    `;
  };
  reader.readAsDataURL(file);
}

function removeImage(previewId, type) {
  currentImage[type] = null;
  g(previewId).innerHTML = '';
  const inputId = type === 'vocab' ? 'v-image-input' : 'edit-image-input';
  g(inputId).value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOCAB CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addVocab() {
  const word = g('v-word').value.trim();
  const translation = g('v-translation').value.trim();
  if (!word || !translation) {
    toast('Word and translation required.', 'err');
    return;
  }
  
  const tags = Array.from(document.querySelectorAll('#v-tags-chips .chip.on')).map(c => c.textContent);
  
  vocab.unshift({
    id: Date.now(),
    gender: g('v-gender').value,
    word,
    translation,
    topic: g('v-topic').value.trim(),
    week: g('v-week').value,
    quarter: g('v-quarter').value,
    year: g('v-year').value,
    cases: g('v-cases').value.trim(),
    context: g('v-context').value.trim(),
    image: currentImage.vocab,
    tags,
    added: Date.now()
  });
  
  clearVocabForm();
  updateTopicDrop();
  updateQuizTopicDrop();
  renderVocab();
  scheduleSave();
  toast('Word added!');
}

function updateDictLinks(prefix) {
  const word = g(`${prefix}-word`).value.trim();
  const linksContainer = g(`${prefix}-dict-links`);
  
  if (!word) {
    linksContainer.style.display = 'none';
    return;
  }
  
  linksContainer.style.display = 'flex';
  const encoded = encodeURIComponent(word);
  
  g(`${prefix}-link-leo`).href = `https://dict.leo.org/englisch-deutsch/${encoded}`;
  g(`${prefix}-link-wikt`).href = `https://en.wiktionary.org/wiki/${encoded}`;
  g(`${prefix}-link-deepl`).href = `https://www.deepl.com/translator#de/en/${encoded}`;
  g(`${prefix}-link-reverso`).href = `https://context.reverso.net/translation/german-english/${encoded}`;
}

function clearVocabForm() {
  ['v-gender', 'v-word', 'v-translation', 'v-topic', 'v-week', 'v-quarter', 'v-year', 'v-cases', 'v-context'].forEach(id => {
    const el = g(id);
    if (el.tagName === 'SELECT') el.selectedIndex = 0;
    else el.value = '';
  });
  document.querySelectorAll('#v-tags-chips .chip').forEach(c => c.classList.remove('on'));
  removeImage('v-image-preview', 'vocab');
  g('v-dict-links').style.display = 'none';
}

function deleteWord(id) {
  if (!confirm('Delete this word?')) return;
  vocab = vocab.filter(v => v.id !== id);
  renderVocab();
  scheduleSave();
}

function openEdit(id) {
  currentEditId = id;
  const v = vocab.find(w => w.id === id);
  if (!v) return;
  
  g('edit-gender').value = v.gender || '';
  g('edit-word').value = v.word;
  g('edit-translation').value = v.translation;
  g('edit-topic').value = v.topic || '';
  g('edit-week').value = v.week || '';
  g('edit-quarter').value = v.quarter || '';
  g('edit-year').value = v.year || '';
  g('edit-cases').value = v.cases || '';
  g('edit-context').value = v.context || '';
  
  if (v.image) {
    currentImage.edit = v.image;
    g('edit-image-preview').innerHTML = `
      <div class="image-preview">
        <img src="${v.image}" alt="Preview">
        <button class="image-remove" onclick="removeImage('edit-image-preview', 'edit')">√ó</button>
      </div>
    `;
  } else {
    removeImage('edit-image-preview', 'edit');
  }
  
  // Update dictionary links for the word being edited
  updateDictLinks('edit');
  
  g('edit-modal').style.display = 'block';
}

function closeEdit() {
  g('edit-modal').style.display = 'none';
  currentEditId = null;
  currentImage.edit = null;
}

function saveEdit() {
  const v = vocab.find(w => w.id === currentEditId);
  if (!v) return;
  
  v.gender = g('edit-gender').value;
  v.word = g('edit-word').value.trim();
  v.translation = g('edit-translation').value.trim();
  v.topic = g('edit-topic').value.trim();
  v.week = g('edit-week').value;
  v.quarter = g('edit-quarter').value;
  v.year = g('edit-year').value;
  v.cases = g('edit-cases').value.trim();
  v.context = g('edit-context').value.trim();
  v.image = currentImage.edit;
  
  closeEdit();
  updateTopicDrop();
  renderVocab();
  scheduleSave();
  toast('Word updated!');
}

function updateTopicDrop() {
  const topics = [...new Set(vocab.map(v => v.topic).filter(Boolean))].sort();
  g('filter-topic').innerHTML = '<option value="">All Topics</option>' + 
    topics.map(t => `<option>${esc(t)}</option>`).join('');
}

function updateQuizTopicDrop() {
  const topics = [...new Set(vocab.map(v => v.topic).filter(Boolean))].sort();
  g('quiz-topic-filter').innerHTML = '<option value="">All Topics</option>' + 
    topics.map(t => `<option>${esc(t)}</option>`).join('');
}

function renderVocab() {
  const sq = g('vocab-search').value.toLowerCase();
  const fg = g('filter-gender').value;
  const fq = g('filter-quarter').value;
  const ft = g('filter-topic').value;
  const sort = g('sort-order').value;
  
  let list = vocab.filter(v => {
    const ms = !sq || [v.word, v.translation, v.context].some(s => (s || '').toLowerCase().includes(sq));
    return ms && (!fg || v.gender === fg) && (!fq || v.quarter === fq) && (!ft || v.topic === ft);
  });
  
  if (sort === 'alpha') list.sort((a, b) => a.word.localeCompare(b.word));
  else if (sort === 'week') list.sort((a, b) => (a.week || 0) - (b.week || 0));
  
  g('vocab-count').textContent = list.length + ' word' + (list.length !== 1 ? 's' : '');
  
  const tot = vocab.length;
  const der = vocab.filter(v => v.gender === 'der').length;
  const die = vocab.filter(v => v.gender === 'die').length;
  const das = vocab.filter(v => v.gender === 'das').length;
  
  g('stats-row').innerHTML = `
    <div class="stat"><div class="stat-num">${tot}</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-num m">${der}</div><div class="stat-label">der</div></div>
    <div class="stat"><div class="stat-num f">${die}</div><div class="stat-label">die</div></div>
    <div class="stat"><div class="stat-num n">${das}</div><div class="stat-label">das</div></div>
    <div class="stat"><div class="stat-num">${tot - der - die - das}</div><div class="stat-label">verbs/phrases</div></div>`;
  
  if (!list.length) {
    g('vocab-grid').innerHTML = `<div class="empty-state"><div class="empty-script">leer</div><p>No words yet ‚Äî or nothing matches.</p></div>`;
    return;
  }
  
  g('vocab-grid').innerHTML = list.map(v => `
    <div class="vocab-card" data-gender="${esc(v.gender)}">
      ${v.image ? `<img src="${v.image}" class="vocab-image" alt="${esc(v.word)}">` : ''}
      <div class="vc-word">
        ${v.gender ? `<span class="vc-art ${v.gender}">${esc(v.gender)}</span>` : ''}
        ${esc(v.word)}
      </div>
      <div class="vc-trans">${esc(v.translation)}</div>
      <div class="vc-tags">
        ${v.topic ? `<span class="tag topic">${esc(v.topic)}</span>` : ''}
        ${v.week ? `<span class="tag">Wk ${esc(v.week)}</span>` : ''}
        ${v.quarter ? `<span class="tag">${esc(v.quarter)}</span>` : ''}
        ${v.year ? `<span class="tag">${esc(v.year)}</span>` : ''}
        ${(v.tags || []).map(t => `<span class="tag">${esc(t)}</span>`).join('')}
      </div>
      ${v.cases || v.context ? `<div class="vc-extra">
        ${v.cases ? `<span class="vc-el">Cases / Conj.</span>${esc(v.cases)}` : ''}
        ${v.context ? `<span class="vc-el">Context</span><div class="vc-ctx">${esc(v.context)}</div>` : ''}
      </div>` : ''}
      <div class="dict-links">
        <a href="https://dict.leo.org/englisch-deutsch/${encodeURIComponent(v.word)}" target="_blank" rel="noopener" class="dict-link" title="LEO Dictionary">LEO</a>
        <a href="https://en.wiktionary.org/wiki/${encodeURIComponent(v.word)}" target="_blank" rel="noopener" class="dict-link" title="Wiktionary">Wikt</a>
        <a href="https://www.deepl.com/translator#de/en/${encodeURIComponent(v.word)}" target="_blank" rel="noopener" class="dict-link" title="DeepL Translator">DeepL</a>
        <a href="https://context.reverso.net/translation/german-english/${encodeURIComponent(v.word)}" target="_blank" rel="noopener" class="dict-link" title="Reverso Context">Rev</a>
      </div>
      <div class="card-actions">
        <button class="btn sec sm" onclick="openEdit(${v.id})">Edit</button>
        <button class="btn sm danger" onclick="deleteWord(${v.id})">Delete</button>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV() {
  if (!vocab.length) {
    toast('No words to export.', 'err');
    return;
  }
  const h = ['gender', 'word', 'translation', 'topic', 'week', 'quarter', 'year', 'cases', 'context'];
  const rows = vocab.map(v => h.map(k => `"${(v[k] || '').toString().replace(/"/g, '""')}"`).join(','));
  const blob = new Blob([[h.join(','), ...rows].join('\n')], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'deutsch_vocab_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
}

function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = e => {
    const lines = e.target.result.trim().split('\n');
    const headers = parseRow(lines[0]);
    let added = 0, skipped = 0;
    for (let i = 1; i < lines.length; i++) {
      const vals = parseRow(lines[i]), obj = {};
      headers.forEach((h, idx) => obj[h.trim()] = (vals[idx] || '').trim());
      if (!obj.word || !obj.translation) {
        skipped++;
        continue;
      }
      if (vocab.some(v => v.word === obj.word && v.translation === obj.translation)) {
        skipped++;
        continue;
      }
      vocab.push({ id: Date.now() + i, ...obj, added: Date.now() });
      added++;
    }
    updateTopicDrop();
    updateQuizTopicDrop();
    renderVocab();
    scheduleSave();
    toast(`Imported ${added} word(s).${skipped ? ` Skipped ${skipped}.` : ''}`);
  };
  r.readAsText(file);
  event.target.value = '';
}

function parseRow(row) {
  const res = [];
  let cur = '', inQ = false;
  for (let i = 0; i < row.length; i++) {
    const c = row[i];
    if (c === '"') {
      if (inQ && row[i + 1] === '"') {
        cur += '"';
        i++;
      } else inQ = !inQ;
    } else if (c === ',' && !inQ) {
      res.push(cur);
      cur = '';
    } else cur += c;
  }
  res.push(cur);
  return res;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTES CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleLink() {
  // Not used anymore, keeping for compatibility
}

function addNote() {
  const title = g('n-title').value.trim();
  if (!title) {
    toast('Title required.', 'err');
    return;
  }
  notes.unshift({
    id: Date.now(),
    type: g('n-type').value,
    title,
    body: g('n-body').value.trim(),
    added: Date.now()
  });
  clearNoteForm();
  renderNotes();
  scheduleSave();
}

function clearNoteForm() {
  ['n-title', 'n-body'].forEach(id => g(id).value = '');
  g('n-type').value = 'note';
}

function deleteNote(id) {
  if (!confirm('Delete?')) return;
  notes = notes.filter(n => n.id !== id);
  renderNotes();
  scheduleSave();
}

const NOTE_LABELS = {
  note: 'General Note',
  grammar: 'Grammar',
  pronunciation: 'Pronunciation',
  culture: 'Culture',
  tip: 'Study Tip',
  phrase: 'Useful Phrase'
};

function renderNotes() {
  const sq = g('note-search').value.toLowerCase();
  const ft = g('note-type-filter').value;
  let list = notes.filter(n => {
    const ms = !sq || [n.title, n.body].some(s => (s || '').toLowerCase().includes(sq));
    return ms && (!ft || n.type === ft);
  });
  g('notes-count').textContent = list.length + ' item' + (list.length !== 1 ? 's' : '');
  if (!list.length) {
    g('notes-grid').innerHTML = `<div class="empty-state"><div class="empty-script">leer</div><p>No notes yet.</p></div>`;
    return;
  }
  g('notes-grid').innerHTML = list.map(n => `
    <div class="note-card">
      <div class="note-type">${NOTE_LABELS[n.type] || n.type}</div>
      <div class="note-title">${esc(n.title)}</div>
      ${n.body ? `<div class="note-body">${esc(n.body)}</div>` : ''}
      <div class="card-actions">
        <button class="btn sm danger" onclick="deleteNote(${n.id})">Delete</button>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESOURCES CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addResource() {
  const title = g('r-title').value.trim();
  if (!title) {
    toast('Title required.', 'err');
    return;
  }
  resources.unshift({
    id: Date.now(),
    type: g('r-type').value,
    title,
    body: g('r-body').value.trim(),
    link: g('r-link').value.trim(),
    added: Date.now()
  });
  clearResourceForm();
  renderResources();
  scheduleSave();
}

function clearResourceForm() {
  ['r-title', 'r-body', 'r-link'].forEach(id => g(id).value = '');
  g('r-type').value = 'youtube';
}

function deleteResource(id) {
  if (!confirm('Delete?')) return;
  resources = resources.filter(r => r.id !== id);
  renderResources();
  scheduleSave();
}

const RESOURCE_LABELS = {
  youtube: 'YouTube',
  website: 'Website',
  book: 'Book',
  podcast: 'Podcast',
  film: 'Film/Series',
  app: 'App',
  other: 'Other'
};

function renderResources() {
  const sq = g('resource-search').value.toLowerCase();
  const ft = g('resource-type-filter').value;
  let list = resources.filter(r => {
    const ms = !sq || [r.title, r.body].some(s => (s || '').toLowerCase().includes(sq));
    return ms && (!ft || r.type === ft);
  });
  g('resources-count').textContent = list.length + ' item' + (list.length !== 1 ? 's' : '');
  if (!list.length) {
    g('resources-grid').innerHTML = `<div class="empty-state"><div class="empty-script">leer</div><p>No resources yet.</p></div>`;
    return;
  }
  g('resources-grid').innerHTML = list.map(r => `
    <div class="resource-card">
      <div class="resource-type">${RESOURCE_LABELS[r.type] || r.type}</div>
      <div class="resource-title">${esc(r.title)}</div>
      ${r.body ? `<div class="resource-body">${esc(r.body)}</div>` : ''}
      ${r.link ? `<a href="${esc(r.link)}" target="_blank" rel="noopener" class="resource-link">${esc(r.link)}</a>` : ''}
      <div class="card-actions">
        <button class="btn sm danger" onclick="deleteResource(${r.id})">Delete</button>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUIZ MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectQuizMode(mode) {
  quizMode = mode;
  document.querySelectorAll('.quiz-mode-btn').forEach(btn => btn.classList.remove('active'));
  event.target.closest('.quiz-mode-btn').classList.add('active');
}

function startQuiz() {
  const count = g('quiz-count').value;
  const topicFilter = g('quiz-topic-filter').value;
  
  let pool = vocab.filter(v => !topicFilter || v.topic === topicFilter);
  
  if (!pool.length) {
    toast('No words available for quiz!', 'err');
    return;
  }
  
  quizData = pool.sort(() => Math.random() - 0.5);
  if (count !== 'all') {
    quizData = quizData.slice(0, parseInt(count));
  }
  
  quizIndex = 0;
  quizScore = 0;
  quizAnswered = false;
  
  showQuestion();
}

function showQuestion() {
  if (quizIndex >= quizData.length) {
    showResults();
    return;
  }
  
  const word = quizData[quizIndex];
  const area = g('quiz-area');
  
  if (quizMode === 'flashcard') {
    area.innerHTML = `
      <div class="quiz-progress">Question ${quizIndex + 1} of ${quizData.length}</div>
      <div class="quiz-card" id="flashcard" onclick="this.classList.toggle('flipped')">
        <div class="quiz-card-front">
          ${word.image ? `<img src="${word.image}" class="quiz-image" alt="image">` : ''}
          ${word.gender ? `<div class="quiz-article">${esc(word.gender)}</div>` : ''}
          <div class="quiz-word">${esc(word.word)}</div>
          <div style="font-size:0.75rem;color:var(--muted);margin-top:1.5rem">Click to flip</div>
        </div>
        <div class="quiz-card-back">
          <div class="quiz-translation">${esc(word.translation)}</div>
          ${word.context ? `<div style="font-size:0.9rem;color:var(--muted);margin-top:1rem;font-style:italic">"${esc(word.context)}"</div>` : ''}
        </div>
      </div>
      <div class="btn-row" style="justify-content:center;margin-top:2rem">
        <button class="btn sec" onclick="quizIndex++;showQuestion()">Next ‚Üí</button>
      </div>
    `;
  } else if (quizMode === 'multiple') {
    const options = [word.translation];
    const otherWords = vocab.filter(v => v.id !== word.id && v.translation !== word.translation);
    while (options.length < 4 && otherWords.length) {
      const idx = Math.floor(Math.random() * otherWords.length);
      options.push(otherWords[idx].translation);
      otherWords.splice(idx, 1);
    }
    options.sort(() => Math.random() - 0.5);
    
    area.innerHTML = `
      <div class="quiz-progress">Question ${quizIndex + 1} of ${quizData.length}</div>
      <div class="quiz-card">
        ${word.image ? `<img src="${word.image}" class="quiz-image" alt="image">` : ''}
        ${word.gender ? `<div class="quiz-article">${esc(word.gender)}</div>` : ''}
        <div class="quiz-word">${esc(word.word)}</div>
      </div>
      <div class="quiz-options">
        ${options.map(opt => `
          <div class="quiz-option" onclick="checkMultiple('${esc(opt)}', '${esc(word.translation)}', this)">
            ${esc(opt)}
          </div>
        `).join('')}
      </div>
      <div class="quiz-feedback" id="quiz-feedback"></div>
      <div class="btn-row" style="justify-content:center;display:none" id="next-btn-container">
        <button class="btn" onclick="quizIndex++;quizAnswered=false;showQuestion()">Next ‚Üí</button>
      </div>
    `;
  } else if (quizMode === 'typing') {
    area.innerHTML = `
      <div class="quiz-progress">Question ${quizIndex + 1} of ${quizData.length}</div>
      <div class="quiz-card">
        ${word.image ? `<img src="${word.image}" class="quiz-image" alt="image">` : ''}
        ${word.gender ? `<div class="quiz-article">${esc(word.gender)}</div>` : ''}
        <div class="quiz-word">${esc(word.word)}</div>
      </div>
      <div class="quiz-input-container">
        <input type="text" class="quiz-input" id="quiz-type-input" placeholder="Type the translation..." onkeypress="if(event.key==='Enter')checkTyping('${esc(word.translation)}')">
      </div>
      <div class="quiz-feedback" id="quiz-feedback"></div>
      <div class="btn-row" style="justify-content:center">
        <button class="btn" onclick="checkTyping('${esc(word.translation)}')">Check Answer</button>
      </div>
      <div class="btn-row" style="justify-content:center;display:none" id="next-btn-container">
        <button class="btn" onclick="quizIndex++;quizAnswered=false;showQuestion()">Next ‚Üí</button>
      </div>
    `;
    setTimeout(() => g('quiz-type-input').focus(), 100);
  } else if (quizMode === 'gender') {
    if (!word.gender) {
      quizIndex++;
      showQuestion();
      return;
    }
    
    area.innerHTML = `
      <div class="quiz-progress">Question ${quizIndex + 1} of ${quizData.length}</div>
      <div class="quiz-card">
        ${word.image ? `<img src="${word.image}" class="quiz-image" alt="image">` : ''}
        <div class="quiz-word">${esc(word.word)}</div>
        <div style="font-size:0.9rem;color:var(--muted);margin-top:0.5rem;font-style:italic">${esc(word.translation)}</div>
      </div>
      <div class="quiz-options">
        <div class="quiz-option" onclick="checkGender('der', '${word.gender}', this)">der</div>
        <div class="quiz-option" onclick="checkGender('die', '${word.gender}', this)">die</div>
        <div class="quiz-option" onclick="checkGender('das', '${word.gender}', this)">das</div>
      </div>
      <div class="quiz-feedback" id="quiz-feedback"></div>
      <div class="btn-row" style="justify-content:center;display:none" id="next-btn-container">
        <button class="btn" onclick="quizIndex++;quizAnswered=false;showQuestion()">Next ‚Üí</button>
      </div>
    `;
  }
}

function checkMultiple(selected, correct, elem) {
  if (quizAnswered) return;
  quizAnswered = true;
  
  const feedback = g('quiz-feedback');
  if (selected === correct) {
    elem.classList.add('correct');
    feedback.textContent = '‚úì Correct!';
    feedback.className = 'quiz-feedback correct';
    quizScore++;
  } else {
    elem.classList.add('incorrect');
    feedback.textContent = `‚úó Incorrect. The answer is: ${correct}`;
    feedback.className = 'quiz-feedback incorrect';
    document.querySelectorAll('.quiz-option').forEach(opt => {
      if (opt.textContent.trim() === correct) opt.classList.add('correct');
    });
  }
  
  g('next-btn-container').style.display = 'flex';
}

function checkTyping(correct) {
  if (quizAnswered) return;
  const input = g('quiz-type-input');
  const answer = input.value.trim().toLowerCase();
  const correctLower = correct.toLowerCase();
  
  quizAnswered = true;
  input.disabled = true;
  
  const feedback = g('quiz-feedback');
  if (answer === correctLower) {
    feedback.textContent = '‚úì Correct!';
    feedback.className = 'quiz-feedback correct';
    input.style.borderColor = 'var(--success)';
    quizScore++;
  } else {
    feedback.textContent = `‚úó Incorrect. The answer is: ${correct}`;
    feedback.className = 'quiz-feedback incorrect';
    input.style.borderColor = 'var(--error)';
  }
  
  g('next-btn-container').style.display = 'flex';
  event.target.style.display = 'none';
}

function checkGender(selected, correct, elem) {
  if (quizAnswered) return;
  quizAnswered = true;
  
  const feedback = g('quiz-feedback');
  if (selected === correct) {
    elem.classList.add('correct');
    feedback.textContent = '‚úì Correct!';
    feedback.className = 'quiz-feedback correct';
    quizScore++;
  } else {
    elem.classList.add('incorrect');
    feedback.textContent = `‚úó Incorrect. The answer is: ${correct}`;
    feedback.className = 'quiz-feedback incorrect';
    document.querySelectorAll('.quiz-option').forEach(opt => {
      if (opt.textContent.trim() === correct) opt.classList.add('correct');
    });
  }
  
  g('next-btn-container').style.display = 'flex';
}

function showResults() {
  const area = g('quiz-area');
  const percentage = Math.round((quizScore / quizData.length) * 100);
  
  area.innerHTML = `
    <div class="quiz-score">
      <div class="quiz-score-number">${quizScore} / ${quizData.length}</div>
      <div class="quiz-score-text">You scored ${percentage}%</div>
      <button class="btn" onclick="startQuiz()">Try Again</button>
    </div>
  `;
}

function resetQuiz() {
  quizData = [];
  quizIndex = 0;
  quizScore = 0;
  quizAnswered = false;
  g('quiz-area').innerHTML = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async () => {
  const user = await SB.restoreSession();
  if (user) {
    await bootApp();
  }
})();
</script>
</body>
</html>
